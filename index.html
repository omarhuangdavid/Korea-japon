<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Gastos de Viaje Detallado v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Fuente Principal */
        }
        /* Estilo para items comprados (solo descripción tachada) */
        .item-purchased .item-description {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* Ocultar detalles de compra por defecto */
        .hidden-details {
            display: none;
        }
        /* Mostrar detalles cuando el checkbox está marcado */
        .item-checkbox:checked ~ .purchase-details {
            display: flex;
        }
         .item-checkbox:checked ~ .purchase-details input,
         .item-checkbox:checked ~ .purchase-details select {
             visibility: visible;
             opacity: 1;
        }
        /* Estilo para la sección de notas (oculta por defecto) */
        .notes-section {
            display: none;
            background-color: #f9fafb; /* gray-50 */
            border-top: 1px solid #e5e7eb; /* gray-200 */
            padding: 12px;
            margin-top: 10px;
            border-radius: 0 0 8px 8px;
        }
        /* Mostrar notas cuando el contenedor tiene la clase 'notes-visible' */
        .notes-visible .notes-section {
            display: block;
        }
        /* Contenedor principal centrado */
        .main-container {
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        /* Animación para el botón de notas */
        .toggle-notes-btn {
            transition: transform 0.2s ease-in-out;
        }
        .notes-visible .toggle-notes-btn {
             transform: rotate(180deg); /* Gira la flecha */
        }
        /* Contenedor del mapa responsivo */
        .map-container {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-top: 56.25%; /* Aspect Ratio 16:9 */
            margin-bottom: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .map-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        /* Estilos para el formulario de añadir gasto */
        #add-expense-form {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #add-expense-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }
        #add-expense-form input[type="text"],
        #add-expense-form input[type="date"],
        #add-expense-form input[type="number"],
        #add-expense-form select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
         #add-expense-form input:focus,
         #add-expense-form select:focus {
             border-color: #86b7fe;
             outline: 0;
             box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
         }
        #add-expense-form button {
            padding: 0.75rem 1.5rem;
            background-color: #0d6efd; /* Azul Bootstrap */
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #add-expense-form button:hover {
            background-color: #0b5ed7;
        }
        /* Mensajes de estado del formulario */
        #form-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            text-align: center;
        }
        .message-success {
            background-color: #d1e7dd; /* Verde Bootstrap */
            color: #0f5132;
            border: 1px solid #badbcc;
        }
         .message-error {
            background-color: #f8d7da; /* Rojo Bootstrap */
            color: #842029;
            border: 1px solid #f5c2c7;
         }
    </style>
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="main-container bg-white p-6 rounded-lg shadow-xl">

        <h1 class="text-2xl md:text-3xl font-bold mb-6 text-center text-gray-800">Registro de Gastos - Corea y Japón</h1>

        <div class="map-container">
             <iframe
                src="https://www.google.com/maps/d/embed?mid=1_EXAMPLE_MAP_ID_REPLACE_ME"
                allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
            </iframe>
            </div>

        <div id="balance-summary" class="mb-8 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 grid grid-cols-1 md:grid-cols-3 gap-4 text-center shadow">
            <div>
                <h3 class="text-lg font-semibold text-blue-800">Pagado por Marian:</h3>
                <p id="marian-total" class="text-xl font-bold text-blue-600">$0.00 USD</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-green-800">Pagado por Omar:</h3>
                <p id="omar-total" class="text-xl font-bold text-green-600">$0.00 USD</p>
            </div>
             <div>
                <h3 class="text-lg font-semibold text-gray-800">Gasto Total Registrado:</h3>
                <p id="grand-total" class="text-xl font-bold text-gray-600">$0.00 USD</p>
            </div>
        </div>

         <div class="mb-6 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-sm text-yellow-800">
            <h4 class="font-semibold mb-1">Nota sobre el Japan Rail Pass (JR Pass):</h4>
            <p>El JR Pass puede ser conveniente si planeas usar mucho los trenes JR, incluido el Shinkansen entre ciudades. Compara el costo total de los trayectos individuales que harás (ver notas en trenes) con el precio del JR Pass para tu duración (7, 14 o 21 días) para decidir si te conviene comprarlo. Los precios del JR Pass varían y deben verificarse en el sitio oficial antes de comprar.</p>
        </div>

        <div id="add-expense-form">
            <h3 class="text-lg font-semibold mb-4 text-gray-700">Añadir Nuevo Gasto</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="new-expense-desc">Descripción:</label>
                    <input type="text" id="new-expense-desc" placeholder="Ej: Cena en Myeongdong">
                </div>
                <div>
                    <label for="new-expense-date">Fecha:</label>
                    <input type="date" id="new-expense-date">
                </div>
                <div>
                    <label for="new-expense-cost">Costo (USD):</label>
                    <input type="number" id="new-expense-cost" placeholder="Ej: 25.50" min="0" step="0.01">
                </div>
                 <div>
                    <label for="new-expense-payer">Pagado por:</label>
                    <select id="new-expense-payer">
                        <option value="" disabled selected>Selecciona quién pagó</option>
                        <option value="Marian">Marian</option>
                        <option value="Omar">Omar</option>
                    </select>
                </div>
                 <div class="md:col-span-2"> <label for="new-expense-category">Categoría:</label>
                    <select id="new-expense-category">
                        <option value="" disabled selected>Selecciona categoría</option>
                        <option value="Comida">Comida</option>
                        <option value="Alojamiento">Alojamiento</option>
                        <option value="Transporte Local">Transporte Local</option>
                        <option value="Entrada">Entrada/Actividad</option>
                        <option value="Souvenir">Souvenir</option>
                        <option value="Compras">Compras</option>
                        <option value="Otros">Otros</option>
                    </select>
                 </div>
            </div>
            <button id="add-expense-button" class="mt-4">Añadir Gasto</button>
            <div id="form-message" class="mt-4" style="display: none;"></div>
        </div>


        <h2 class="text-xl font-semibold mb-4 text-gray-700">Lista de Gastos y Actividades (Ordenados por Fecha)</h2>
        <div id="expense-list" class="space-y-4">
            </div>

    </div> <script>
        // --- Datos Iniciales del Itinerario (Gastos Principales Planificados) ---
        let itineraryItems = [
           // Vuelos (Fechas basadas en tu itinerario corregido)
          { id: 1, date: "2025-11-11", description: "Vuelo AC99 BOG-YUL", purchased: false, cost: 0, payer: null, category: 'Vuelo', notes: "Inicio del viaje desde Bogotá." },
          { id: 2, date: "2025-11-12", description: "Vuelo AC7773/AC061 YUL-ICN", purchased: false, cost: 0, payer: null, category: 'Vuelo', notes: "Vuelo de conexión a Seúl vía Toronto." },
          { id: 15, date: "2025-11-18", description: "Vuelo Busan-Jeju (PUS-CJU)", purchased: false, cost: 0, payer: null, category: 'Vuelo', notes: "Vuelo doméstico a la Isla de Jeju. Aerolíneas comunes: Jeju Air, Jin Air, T'way Air, Air Busan. Reservar con antelación." },
          { id: 20, date: "2025-11-20", description: "Vuelo Jeju-Osaka (CJU-KIX)", purchased: false, cost: 0, payer: null, category: 'Vuelo', notes: "Vuelo internacional a Japón (Osaka). Aerolíneas comunes: Peach, Jetstar Japan. Reservar con antelación." },
          { id: 33, date: "2025-11-28", description: "Vuelo AC 010 NRT-YYZ", purchased: false, cost: 0, payer: null, category: 'Vuelo', notes: "Vuelo de regreso desde Tokio (Narita) a Toronto." },
          // Transporte Terrestre Principal
          { id: 3, date: "2025-11-13", description: "Traslado ICN-Seúl", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Opciones: AREX Express (rápido, directo a Seoul Station, ~9,500 KRW), AREX All Stop (más paradas, más barato, ~4,500 KRW), Bus Limusina (cómodo, directo a zonas hoteleras, ~17,000 KRW), Taxi (más caro, ~60,000+ KRW)." },
          { id: 8, date: "2025-11-16", description: "KTX Seúl-Gyeongju", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Tren bala desde Seoul Station a Singyeongju Station (a las afueras de Gyeongju). Duración: ~2 horas. Costo aprox: 50,000 KRW. Reservar en Korail." },
          { id: 13, date: "2025-11-17", description: "KTX Gyeongju-Busan", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Tren bala desde Singyeongju Station a Busan Station. Duración: ~30-40 min. Costo aprox: 11,000 - 17,000 KRW. Reservar en Korail." },
          { id: 16, date: "2025-11-19", description: "Alquiler Coche Jeju", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Recomendado para explorar la isla con flexibilidad. Se necesita Permiso de Conducir Internacional (IDP). Costo aprox: 40,000 - 70,000 KRW/día + gasolina. Alternativas: Autobús turístico, taxi." },
          { id: 21, date: "2025-11-20", description: "JR Haruka Express KIX-Kioto", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Tren directo desde el aeropuerto de Kansai (KIX) a Kyoto Station. Duración: ~75 min.", costWithJRPass: 0, costWithoutJRPass: 3000 }, // Costo aprox en JPY
          { id: 30, date: "2025-11-24", description: "Shinkansen Kioto-Tokio", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Tren bala desde Kyoto Station a Tokyo Station o Shinagawa Station. Duración: ~2.5 horas (Nozomi) o ~3 horas (Hikari). Nozomi no está cubierto por JR Pass estándar.", costWithJRPass: 0, costWithoutJRPass: 14000 }, // Costo aprox en JPY (asiento reservado)
          { id: 32, date: "2025-11-28", description: "Narita Express Tokio-NRT", purchased: false, cost: 0, payer: null, category: 'Transporte', notes: "Tren directo desde estaciones principales de Tokio (Tokyo, Shinjuku, Shibuya, etc.) al Aeropuerto de Narita (NRT). Duración: ~60-90 min.", costWithJRPass: 0, costWithoutJRPass: 3000 }, // Costo aprox en JPY
          // Entradas y Tours
          { id: 4, date: "2025-11-14", description: "Entrada Palacio Gyeongbokgung", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "El palacio real más grande y principal de Seúl. Ver la ceremonia del cambio de guardia (10:00 y 14:00). Plan: Explorar los patios, salones principales y jardines. Cerca de Bukchon Hanok Village." },
          { id: 5, date: "2025-11-15", description: "Tour DMZ", purchased: false, cost: 0, payer: null, category: 'Tour', notes: "Excursión a la Zona Desmilitarizada, la frontera entre Corea del Norte y Corea del Sur. Incluye visitas al JSA (Área de Seguridad Conjunta - si está disponible), túneles de infiltración y observatorios. Requiere reserva anticipada y pasaporte. Es una experiencia histórica y tensa." },
          { id: 7, date: "2025-11-15", description: "Entrada N Seoul Tower", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Torre icónica en la montaña Namsan con vistas panorámicas de 360° de Seúl. Subir en teleférico o autobús. Popular por los 'candados del amor'. Mejor al atardecer/noche." },
          { id: 9, date: "2025-11-16", description: "Entrada Parque Tumuli", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Parque en Gyeongju que alberga grandes túmulos funerarios cubiertos de hierba de los gobernantes del Reino de Silla. Destaca la Tumba Cheonmachong (abierta al público con réplicas de artefactos). Paseo tranquilo." },
          { id: 10, date: "2025-11-16", description: "Entrada Observatorio Cheomseongdae", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Uno de los observatorios astronómicos más antiguos de Asia Oriental, construido durante el Reino de Silla (siglo VII). Situado cerca del Parque Tumuli. Interesante estructura de piedra." },
          { id: 11, date: "2025-11-17", description: "Entrada Templo Bulguksa", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Importante complejo de templos budistas en Gyeongju, Patrimonio de la Humanidad por la UNESCO. Arquitectura hermosa y significado histórico. Plan: Explorar los diferentes salones, pagodas (Dabotap y Seokgatap) y patios." },
           { id: 12, date: "2025-11-18", description: "Visita Gamcheon Culture Village", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Antiguo barrio en Busan transformado en un vibrante pueblo artístico con casas de colores, murales, esculturas y galerías. Plan: Perderse por sus callejones, seguir la ruta de los sellos, disfrutar las vistas. Entrada general gratuita, algunas atracciones internas pueden costar." }, // Cambiado a Visita, ya que la entrada es gratis
          { id: 17, date: "2025-11-19", description: "Entrada Seongsan Ilchulbong", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Cono volcánico ('Pico del Amanecer') en la costa este de Jeju, Patrimonio de la Humanidad. Famoso por las vistas espectaculares al amanecer desde la cima (subida de ~20-30 min). También hay espectáculos de Haenyeo (mujeres buceadoras) en la base." },
          { id: 18, date: "2025-11-19", description: "Entrada Cueva Manjanggul", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Uno de los tubos de lava más largos y mejor conservados del mundo, Patrimonio de la Humanidad. Se puede caminar 1 km dentro de la cueva para ver formaciones de lava únicas. Llevar calzado cómodo y algo de abrigo (la cueva es fresca)." },
          { id: 23, date: "2025-11-21", description: "Entrada Universal Studios Japan (USJ)", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Parque temático en Osaka. Principal atracción: Super Nintendo World (puede requerir entrada programada o pase aparte, verificar sistema actual). Otras áreas: Harry Potter, Jurassic Park, Minions. Plan: Llegar temprano, priorizar atracciones. Comprar entradas con antelación." },
          { id: 25, date: "2025-11-22", description: "Entrada Kinkaku-ji", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Templo Zen Budista en Kioto, famoso por su Pabellón Dorado completamente cubierto de pan de oro, reflejándose en el estanque. Uno de los lugares más icónicos de Japón. Plan: Recorrer los jardines que rodean el pabellón." },
          { id: 26, date: "2025-11-22", description: "Entrada Ryoan-ji", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Templo Zen en Kioto, mundialmente famoso por su jardín seco (karesansui) o jardín de rocas. Un espacio minimalista para la contemplación. El significado exacto de la disposición de las 15 rocas es objeto de debate. Plan: Sentarse a observar el jardín." },
          { id: 27, date: "2025-11-23", description: "Entrada Kiyomizu-dera", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Templo budista famoso por su plataforma de madera que sobresale de la ladera, construida sin clavos, con vistas de Kioto. También conocido por la cascada Otowa. Ubicado en las colinas de Higashiyama. Plan: Visitar el templo y luego explorar las calles Sannenzaka y Ninenzaka." },
          { id: 28, date: "2025-11-23", description: "Visita Fushimi Inari-taisha", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "Santuario sintoísta dedicado a Inari, el dios del arroz. Famoso por sus miles de puertas torii rojas que forman senderos por la montaña. Entrada gratuita. Plan: Caminar por los senderos de toriis (se puede subir hasta la cima, ~2-3 horas ida y vuelta, o hacer un recorrido más corto)." }, // Entrada gratuita
           { id: 34, date: "2025-11-27", description: "Entrada Museo Nacional de Tokio", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "El museo más grande y antiguo de Japón, ubicado en el Parque Ueno. Alberga una vasta colección de arte y artefactos arqueológicos japoneses y asiáticos. Plan: Elegir una o dos galerías principales según interés (ej. Honkan - Galería Japonesa). Costo aprox: 1000 JPY." },
           { id: 35, date: "2025-11-27", description: "Visita Templo Senso-ji", purchased: false, cost: 0, payer: null, category: 'Entrada', notes: "El templo budista más antiguo y uno de los más significativos de Tokio, ubicado en Asakusa. Se accede a través de la puerta Kaminarimon y la calle comercial Nakamise-dori. Entrada gratuita al recinto del templo. Plan: Visitar el templo, pasear por Nakamise-dori." }, // Entrada gratuita
        ];

        // --- Referencias a Elementos del DOM ---
        const expenseListContainer = document.getElementById('expense-list');
        const marianTotalEl = document.getElementById('marian-total');
        const omarTotalEl = document.getElementById('omar-total');
        const grandTotalEl = document.getElementById('grand-total');
        const addExpenseButton = document.getElementById('add-expense-button');
        const formMessageEl = document.getElementById('form-message');

        // --- Funciones ---

        /**
         * Guarda el estado actual de itineraryItems en localStorage.
         */
        function saveData() {
            localStorage.setItem('travelExpenses_v3', JSON.stringify(itineraryItems));
        }

        /**
         * Carga el estado de itineraryItems desde localStorage, si existe.
         * Asegura que todos los items tengan IDs únicos después de cargar.
         */
        function loadData() {
            const savedData = localStorage.getItem('travelExpenses_v3');
            if (savedData) {
                itineraryItems = JSON.parse(savedData);
            }
            ensureUniqueIds(); // Asegurar IDs únicos después de cargar o si es la primera vez
        }

        /**
         * Revisa todos los items y asigna un ID único si falta o está duplicado.
         */
         function ensureUniqueIds() {
             let maxId = 0;
             const existingIds = new Set();
             itineraryItems.forEach(item => {
                 if (item.id !== undefined && item.id !== null) {
                     if (existingIds.has(item.id)) {
                         // ID duplicado, necesita uno nuevo
                         item.id = generateNewId(maxId); // Pasar maxId actual para eficiencia
                     } else {
                         existingIds.add(item.id);
                         maxId = Math.max(maxId, item.id);
                     }
                 } else {
                    // Item sin ID, necesita uno nuevo
                    item.id = generateNewId(maxId);
                 }
                 existingIds.add(item.id); // Añadir el ID (nuevo o existente validado) al set
                 maxId = Math.max(maxId, item.id); // Actualizar maxId rastreado
             });
         }

        /**
         * Genera un nuevo ID único basado en el ID máximo actual + 1.
         * @param {number} currentMaxId - El ID máximo conocido actualmente.
         * @returns {number} Un nuevo ID único.
         */
         function generateNewId(currentMaxId = -1) {
             if (currentMaxId === -1) {
                 currentMaxId = itineraryItems.reduce((max, item) => Math.max(max, item.id || 0), 0);
             }
             let newId = currentMaxId + 1;
             // Bucle de seguridad por si acaso (poco probable con incremento simple)
             while (itineraryItems.some(item => item.id === newId)) {
                 newId++;
             }
             return newId;
         }

        /**
         * Calcula los totales pagados por cada persona y el total general,
         * y actualiza los elementos correspondientes en el DOM.
         */
        function updateBalance() {
            let marianTotal = 0;
            let omarTotal = 0;
            let grandTotal = 0;

            itineraryItems.forEach(item => {
                // Sumar solo si está marcado como comprado, tiene costo > 0 y un pagador asignado
                 if (item.purchased && item.cost > 0 && item.payer) {
                    const cost = parseFloat(item.cost) || 0;
                     grandTotal += cost;
                    if (item.payer === 'Marian') {
                        marianTotal += cost;
                    } else if (item.payer === 'Omar') {
                        omarTotal += cost;
                    }
                }
            });

            // Función para formatear números como moneda USD
            const formatCurrency = (amount) => amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            // Actualizar el texto en los elementos del resumen
            marianTotalEl.textContent = formatCurrency(marianTotal);
            omarTotalEl.textContent = formatCurrency(omarTotal);
            grandTotalEl.textContent = formatCurrency(grandTotal);
        }

        /**
         * Formatea las notas de un item para mostrarlas en la sección desplegable.
         * Incluye información especial para costos de transporte con/sin JR Pass.
         * @param {object} item - El objeto del item del itinerario.
         * @returns {string} HTML formateado para las notas.
         */
        function formatNotes(item) {
             // Si es un item añadido manualmente, mostrar solo la categoría (o una nota simple)
             if (item.isManualEntry) {
                 return `<p class="text-sm text-gray-600">Categoría: ${item.category || 'No especificada'}</p>`;
             }

            // Lógica para items predefinidos
            let notesHTML = `<p class="text-sm text-gray-600">${item.notes || 'No hay notas adicionales.'}</p>`;
            // Añadir detalles de costo JR Pass si existen
            if (item.costWithoutJRPass !== undefined) {
                notesHTML += `<div class="mt-2 pt-2 border-t border-gray-200">
                                <p class="text-sm font-semibold text-gray-700">Costo Transporte (Aprox JPY):</p>
                                <ul class="list-disc list-inside text-sm text-gray-600">
                                    <li>Sin JR Pass: ${item.costWithoutJRPass.toLocaleString('ja-JP')} JPY</li>
                                    <li>Con JR Pass: ${ (item.costWithJRPass !== undefined && item.costWithJRPass === 0) ? 'Cubierto (si activo y elegible)' : (item.costWithJRPass ? item.costWithJRPass.toLocaleString('ja-JP') + ' JPY' : 'N/A') }</li>
                                </ul>
                             </div>`;
            }
            return notesHTML;
        }

        /**
         * Muestra un mensaje temporal (éxito o error) en el área designada del formulario.
         * @param {string} message - El mensaje a mostrar.
         * @param {boolean} isSuccess - true para mensaje de éxito (verde), false para error (rojo).
         */
        function showFormMessage(message, isSuccess = true) {
            formMessageEl.textContent = message;
            formMessageEl.className = `mt-4 ${isSuccess ? 'message-success' : 'message-error'}`; // Aplica clase CSS para color
            formMessageEl.style.display = 'block'; // Muestra el mensaje
            // Oculta el mensaje después de 3 segundos
            setTimeout(() => {
                formMessageEl.style.display = 'none';
            }, 3000);
        }

        /**
         * Limpia todos los campos del formulario de añadir nuevo gasto.
         */
        function clearAddExpenseForm() {
            document.getElementById('new-expense-desc').value = '';
            document.getElementById('new-expense-date').value = '';
            document.getElementById('new-expense-cost').value = '';
            document.getElementById('new-expense-payer').selectedIndex = 0; // Resetea el select
            document.getElementById('new-expense-category').selectedIndex = 0; // Resetea el select
        }

        /**
         * Renderiza la lista completa de gastos en el contenedor 'expense-list'.
         * Ordena los items por fecha antes de renderizar.
         * Añade event listeners a los elementos interactivos de cada item.
         */
        function renderExpenseList() {
            expenseListContainer.innerHTML = ''; // Limpiar contenedor antes de re-renderizar

            // *** Ordenar el array itineraryItems por fecha (ascendente) ***
            itineraryItems.sort((a, b) => {
                // Tratar fechas nulas o inválidas poniéndolas al final
                const dateA = a.date ? new Date(a.date + 'T00:00:00') : null; // Añadir T00:00:00 para evitar problemas de zona horaria al comparar solo fechas
                const dateB = b.date ? new Date(b.date + 'T00:00:00') : null;

                if (!dateA && !dateB) return 0; // Ambos sin fecha, mantener orden relativo
                if (!dateA) return 1;          // 'a' sin fecha va después que 'b' con fecha
                if (!dateB) return -1;         // 'b' sin fecha va después que 'a' con fecha
                return dateA - dateB;          // Ordenar cronológicamente si ambas fechas son válidas
            });

            // --- Crear y añadir elementos del DOM para cada item ---
            itineraryItems.forEach((item) => { // No necesitamos el índice aquí ya que usamos IDs
                const itemWrapper = document.createElement('div');
                // Aplicar fondo verde si está comprado
                itemWrapper.className = `item-wrapper border rounded-lg shadow-sm overflow-hidden ${item.purchased ? 'bg-green-50' : 'bg-white'}`;
                 // Añadir clase para mostrar notas si estaba visible previamente
                 if (item.notesVisible) {
                    itemWrapper.classList.add('notes-visible');
                 }

                // Contenedor principal del item (visible siempre)
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item-container p-4 flex flex-col md:flex-row md:items-center justify-between gap-4';

                // --- Sección Izquierda: Checkbox, Fecha, Descripción ---
                const leftSection = document.createElement('div');
                leftSection.className = 'flex items-center space-x-3 flex-grow min-w-0'; // min-w-0 previene overflow

                // Checkbox para marcar como comprado
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.purchased;
                checkbox.id = `item-${item.id}`; // ID único para el label
                checkbox.className = 'item-checkbox h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer flex-shrink-0';
                checkbox.dataset.itemId = item.id; // Guardar ID del item para referencia en eventos

                // Div para agrupar fecha y descripción
                const descriptionDiv = document.createElement('div');
                descriptionDiv.className = 'flex-grow min-w-0'; // min-w-0

                // Span para la fecha
                const dateSpan = document.createElement('span');
                 try {
                     // Formatear fecha en español (ej: 4 may. 2025) - Usar UTC para consistencia
                     dateSpan.textContent = item.date ? new Date(item.date + 'T00:00:00Z').toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' }) : 'Sin fecha';
                 } catch (e) {
                     console.error("Error formateando fecha:", item.date, e);
                     dateSpan.textContent = 'Fecha inválida';
                 }
                dateSpan.className = 'text-xs text-gray-500 block md:inline md:mr-2';

                // Label para la descripción (asociado al checkbox)
                const label = document.createElement('label');
                label.htmlFor = `item-${item.id}`;
                label.textContent = item.description;
                // Aplicar clase para tachar si está comprado y truncar texto largo
                label.className = `item-description block text-gray-800 font-medium cursor-pointer truncate ${item.purchased ? 'item-purchased' : ''}`;
                label.title = item.description; // Añadir tooltip con descripción completa

                descriptionDiv.appendChild(dateSpan);
                descriptionDiv.appendChild(label);
                // Mostrar categoría si es una entrada manual
                if (item.isManualEntry && item.category) {
                    const categorySpan = document.createElement('span');
                    categorySpan.textContent = ` (${item.category})`;
                    categorySpan.className = 'text-xs text-purple-600 italic ml-1';
                    descriptionDiv.appendChild(categorySpan);
                }

                leftSection.appendChild(checkbox);
                leftSection.appendChild(descriptionDiv);

                // --- Sección Derecha: Detalles de Compra, Botón Notas ---
                const rightSection = document.createElement('div');
                rightSection.className = 'flex flex-col md:flex-row items-stretch md:items-center gap-2 md:gap-4 flex-shrink-0'; // Evita que se encoja

                // Div para detalles de compra (costo, pagador) - Oculto si no está comprado
                const purchaseDetailsDiv = document.createElement('div');
                purchaseDetailsDiv.className = `purchase-details flex flex-col sm:flex-row items-start sm:items-center gap-2 mt-2 md:mt-0 ${item.purchased ? '' : 'hidden-details'}`;

                // Input para el costo real
                const costInput = document.createElement('input');
                costInput.type = 'number';
                costInput.placeholder = 'Costo (USD)';
                costInput.value = item.cost > 0 ? item.cost : '';
                costInput.min = '0';
                costInput.step = '0.01';
                costInput.className = 'cost-input p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full sm:w-28'; // Ancho fijo
                costInput.dataset.itemId = item.id; // Guardar ID del item

                // Select para el pagador
                const payerSelect = document.createElement('select');
                payerSelect.className = 'payer-select p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm w-full sm:w-32'; // Ancho fijo
                payerSelect.dataset.itemId = item.id; // Guardar ID del item

                // Opciones del select (Default, Marian, Omar)
                const optionDefault = document.createElement('option');
                optionDefault.value = "";
                optionDefault.textContent = "Quién pagó?";
                optionDefault.disabled = true;
                optionDefault.selected = !item.payer;
                payerSelect.appendChild(optionDefault);

                const optionMarian = document.createElement('option');
                optionMarian.value = "Marian";
                optionMarian.textContent = "Marian";
                optionMarian.selected = item.payer === 'Marian';
                payerSelect.appendChild(optionMarian);

                const optionOmar = document.createElement('option');
                optionOmar.value = "Omar";
                optionOmar.textContent = "Omar";
                optionOmar.selected = item.payer === 'Omar';
                payerSelect.appendChild(optionOmar);

                purchaseDetailsDiv.appendChild(costInput);
                purchaseDetailsDiv.appendChild(payerSelect);

                // Botón para mostrar/ocultar notas
                const toggleButton = document.createElement('button');
                toggleButton.className = 'toggle-notes-btn p-2 text-gray-500 hover:text-blue-600 flex-shrink-0';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>'; // Icono Font Awesome
                toggleButton.dataset.itemId = item.id; // Guardar ID del item
                toggleButton.setAttribute('aria-label', 'Mostrar/Ocultar notas');
                 // Ocultar botón si no hay notas significativas (ej. items manuales sin notas)
                 if (item.isManualEntry && !item.notes) { // O una lógica más robusta
                     toggleButton.style.visibility = 'hidden';
                 }

                rightSection.appendChild(purchaseDetailsDiv);
                rightSection.appendChild(toggleButton);

                // --- Sección de Notas (oculta por defecto) ---
                const notesDiv = document.createElement('div');
                notesDiv.className = 'notes-section px-4 pb-4'; // Estilos aplicados directamente
                notesDiv.innerHTML = formatNotes(item); // Poblar con notas formateadas

                // --- Ensamblar el Item Completo ---
                itemDiv.appendChild(leftSection);   // Añadir sección izquierda
                itemDiv.appendChild(rightSection);  // Añadir sección derecha
                itemWrapper.appendChild(itemDiv);   // Añadir contenedor principal al wrapper
                itemWrapper.appendChild(notesDiv);  // Añadir sección de notas al wrapper
                expenseListContainer.appendChild(itemWrapper); // Añadir el wrapper completo a la lista

                // --- Añadir Event Listeners (usando ID del item para encontrarlo después de ordenar) ---

                // Función auxiliar para encontrar el índice del item en el array por su ID
                 const findItemIndexById = (id) => itineraryItems.findIndex(itm => itm.id === id);

                // Listener para el checkbox
                checkbox.addEventListener('change', (e) => {
                    const itemId = parseInt(e.target.dataset.itemId); // Obtener ID del item del dataset
                    const idx = findItemIndexById(itemId); // Encontrar índice actual en el array
                    if (idx === -1) { console.error("Item not found for checkbox:", itemId); return; } // Seguridad

                    const isChecked = e.target.checked;
                    itineraryItems[idx].purchased = isChecked;

                    // Si se desmarca, resetear costo y pagador (opcional, pero lógico)
                    if (!isChecked) {
                        itineraryItems[idx].cost = 0;
                        itineraryItems[idx].payer = null;
                    }
                    renderExpenseList(); // Re-renderizar para actualizar estado visual (fondo, tachado) y detalles
                    updateBalance();     // Recalcular saldos
                    saveData();          // Guardar cambios
                });

                // Listener para el input de costo (actualiza en 'input', guarda en 'change')
                costInput.addEventListener('input', (e) => {
                     const itemId = parseInt(e.target.dataset.itemId);
                     const idx = findItemIndexById(itemId);
                     if (idx === -1) { console.error("Item not found for cost input:", itemId); return; }

                    const costValue = parseFloat(e.target.value) || 0;
                    itineraryItems[idx].cost = costValue >= 0 ? costValue : 0; // Asegurar que sea >= 0
                    updateBalance(); // Actualizar saldos mientras se escribe
                });
                 costInput.addEventListener('change', (e) => { // Guardar solo cuando se deja de editar el campo
                     saveData();
                 });

                // Listener para el select de pagador
                payerSelect.addEventListener('change', (e) => {
                    const itemId = parseInt(e.target.dataset.itemId);
                    const idx = findItemIndexById(itemId);
                    if (idx === -1) { console.error("Item not found for payer select:", itemId); return; }

                    itineraryItems[idx].payer = e.target.value; // Guardar el valor seleccionado
                    updateBalance(); // Actualizar saldos
                    saveData();      // Guardar cambios
                });

                // Listener para el botón de mostrar/ocultar notas
                toggleButton.addEventListener('click', (e) => {
                    const button = e.currentTarget; // El botón que fue clickeado
                    const itemId = parseInt(button.dataset.itemId);
                    const idx = findItemIndexById(itemId);
                    if (idx === -1) { console.error("Item not found for toggle notes:", itemId); return; }

                    const wrapper = button.closest('.item-wrapper'); // Encontrar el contenedor padre del item
                    // Alternar la clase 'notes-visible' en el wrapper
                    const notesAreVisible = wrapper.classList.toggle('notes-visible');
                    // Guardar el estado de visibilidad en el objeto del item
                    itineraryItems[idx].notesVisible = notesAreVisible;
                    saveData(); // Guardar el nuevo estado de visibilidad
                });
            }); // Fin del forEach
        } // Fin de renderExpenseList

         // --- Event Listener para el botón de Añadir Gasto ---
         addExpenseButton.addEventListener('click', () => {
             // Obtener valores del formulario
             const descriptionInput = document.getElementById('new-expense-desc');
             const dateInput = document.getElementById('new-expense-date');
             const costInput = document.getElementById('new-expense-cost');
             const payerInput = document.getElementById('new-expense-payer');
             const categoryInput = document.getElementById('new-expense-category');

             const description = descriptionInput.value.trim();
             const date = dateInput.value;
             const cost = parseFloat(costInput.value) || 0;
             const payer = payerInput.value;
             const category = categoryInput.value;

             // Validación simple de campos requeridos
             if (!description || !date || cost <= 0 || !payer || !category) {
                 showFormMessage('Por favor, completa todos los campos correctamente.', false); // Mostrar mensaje de error
                 return; // Detener ejecución si falta información
             }

             // Crear nuevo objeto de gasto
             const newExpense = {
                 id: generateNewId(), // Generar un ID único nuevo
                 date: date,
                 description: description,
                 purchased: true, // Marcar como comprado por defecto al añadir manualmente
                 cost: cost,
                 payer: payer,
                 category: category,
                 notes: null, // No hay notas detalladas predefinidas para items manuales
                 isManualEntry: true, // Marcar como entrada manual
                 notesVisible: false // Notas ocultas por defecto
             };

             // Añadir el nuevo gasto al array principal
             itineraryItems.push(newExpense);

             // Guardar, actualizar balance, re-renderizar lista (que se ordenará) y limpiar formulario
             saveData();
             updateBalance();
             renderExpenseList(); // La lista se re-renderizará ordenada por fecha
             clearAddExpenseForm(); // Limpiar campos del formulario
             showFormMessage('¡Gasto añadido con éxito!', true); // Mostrar mensaje de éxito
         });


        // --- Inicialización de la Aplicación ---
        // Cargar datos guardados (si existen) al iniciar
        loadData();
        // Renderizar la lista inicial (ya ordenada por fecha)
        renderExpenseList();
        // Calcular y mostrar el balance inicial
        updateBalance();

    </script>

</body>
</html>
